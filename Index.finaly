<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ú©Ø§Ù…Ù„ ÙØ§Ø±Ú©Ø³ | Ø­Ø¬Ù… Ù¾ÙˆØ²ÛŒØ´Ù† Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©</title>
  <style>
    /* ====== Design System (Minimal & Clean) ====== */
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#8da2c0; --text:#e5eaf2; --line:#1e293b;
      --accent:#22c55e; --accent-2:#38bdf8; --warn:#f59e0b; --error:#ef4444;
      --chip:#111a2e; --shadow:0 12px 30px rgba(0,0,0,.25);
      --radius:16px; --radius-sm:12px; --pad:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:IRANSans,Inter,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{margin:0 0 8px;font-size:22px}
    p.muted{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,minmax(0,1fr))}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .kpi{background:#0a1326;border:1px solid var(--line);border-radius:var(--radius-sm);padding:12px;text-align:center}
    .kpi h3{margin:0;color:var(--muted);font-size:12px}
    .kpi p{margin:6px 0 0;font-size:18px}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 0 6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0a1326;color:var(--text);font-size:14px}
    input:focus,select:focus{outline:2px solid #21314b}
    .row{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    .btn{cursor:pointer;transition:.15s;background:#162032}
    .btn:hover{transform:translateY(-1px)}
    .primary{background:var(--accent);border-color:var(--accent);color:#04110a;font-weight:700}
    .outline{background:transparent}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:6px 10px;border-radius:999px;background:var(--chip);color:#cfd8e4;border:1px solid var(--line);font-size:11px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:center;font-size:13px}
    th{color:#aab7ce;font-weight:600}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .col-9{grid-column:span 9}.col-3{grid-column:span 3}
    .col-12{grid-column:span 12}
    .tag-ok{color:#a7f3d0}.tag-bad{color:#fecaca}.tag-warn{color:#fde68a}
    @media (max-width:980px){
      .grid{grid-template-columns:repeat(6,minmax(0,1fr))}
      .col-9{grid-column:span 6}.col-3{grid-column:span 6}
      .kpis{grid-template-columns:repeat(2,minmax(0,1fr))}
      .row{grid-template-columns:1fr}
    }
    @media (max-width:560px){
      .grid{grid-template-columns:repeat(1,minmax(0,1fr))}
      .col-9,.col-3,.col-12{grid-column:span 1}
      .kpis{grid-template-columns:1fr 1fr}
    }
    /* small helper badges */
    .hint{font-size:11px;color:var(--muted);margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ù…Ø§Ø´ÛŒÙ†â€ŒØ­Ø³Ø§Ø¨ Ú©Ø§Ù…Ù„ ÙØ§Ø±Ú©Ø³ (Ø­Ø¬Ù… Ù¾ÙˆØ²ÛŒØ´Ù†ØŒ Ø±ÛŒØ³Ú©ØŒ Ø³ÙˆØ¯ØŒ R:R)</h1>
    <p class="muted">Ø¨Ø±Ø§ÛŒ Ø§Ú©Ø«Ø± Ø¬ÙØªâ€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ú©Ø³ (ØºÛŒØ±Ù JPY): Ù‡Ø± <b>Û± Ù¾ÛŒÙ¾</b> Ø¯Ø± <b>Û± Ù„Ø§Øª â‰ˆ 10$</b> â€” Ø¨Ø±Ø§ÛŒ USDJPY: <b>1000 / Ù‚ÛŒÙ…Øª</b> â€” Ø¨Ø±Ø§ÛŒ Ø·Ù„Ø§ (XAUUSD): Ù‡Ø± <b>Û± Ø¯Ù„Ø§Ø±</b> Ø­Ø±Ú©Øª Ø¯Ø± <b>Û± Ù„Ø§Øª â‰ˆ 100$</b>.</p>

    <div class="grid">
      <!-- Form -->
      <div class="card col-9">
        <div class="grid" style="gap:12px;grid-template-columns:repeat(4,minmax(0,1fr))">
          <div>
            <label>Ù†Ù…Ø§Ø¯</label>
            <input id="symbol" placeholder="EURUSD / USDJPY / XAUUSD" value="XAUUSD">
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ø¨Ø²Ø§Ø±</label>
            <select id="instrument">
              <option value="forex">Forex (ØºÛŒØ±Ù JPY)</option>
              <option value="forex-jpy">Forex (JPY quote)</option>
              <option value="gold" selected>Gold (XAUUSD)</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div>
            <label>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨ ($)</label>
            <input id="balance" type="number" value="1000">
          </div>
          <div>
            <label>Ø±ÛŒØ³Ú© Ù‡Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡ (%)</label>
            <input id="riskPct" type="number" step="0.1" value="1.5">
          </div>

          <div>
            <label>Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯</label>
            <input id="entry" type="number" step="0.0001" value="2350">
          </div>
          <div>
            <label>Ø­Ø¯ Ø¶Ø±Ø±</label>
            <input id="sl" type="number" step="0.0001" value="2347.5">
          </div>
          <div>
            <label>Ø­Ø¯ Ø³ÙˆØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <input id="tp" type="number" step="0.0001" placeholder="Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ Ø§Ø² R:R Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯">
            <div class="hint">Ø§Ú¯Ø± Ø§ÛŒÙ† Ø±Ø§ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØŒ Ø¨Ø§ Ù†Ø³Ø¨Øª R:R Ø²ÛŒØ± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
          </div>
          <div>
            <label>Ù‡Ø¯Ù R:R (ÙˆÙ‚ØªÛŒ TP Ø®Ø§Ù„ÛŒ Ø§Ø³Øª)</label>
            <input id="rrTarget" type="number" step="0.1" value="2">
          </div>

          <div>
            <label>Ø§Ø±Ø²Ø´ Ù‡Ø± ÙˆØ§Ø­Ø¯ Ø­Ø±Ú©Øª Ø¨Ø±Ø§ÛŒ Û± Ù„Ø§Øª ($)</label>
            <input id="unitValue" type="number" step="0.01" value="100">
            <div class="hint">Ø¨Ø±Ø§ÛŒ XAUUSD = 100 ØŒ Ø¨Ø±Ø§ÛŒ EURUSD â‰ˆ 10 ØŒ Ø¨Ø±Ø§ÛŒ USDJPY â‰ˆ 1000/Price</div>
          </div>
          <div>
            <label>Ø§Ù‡Ø±Ù… (Leverage) (Ù…Ø«Ù„ 100 ÛŒØ¹Ù†ÛŒ 1:100)</label>
            <input id="leverage" type="number" step="1" value="100">
          </div>
          <div>
            <label>Ú©Ù…ÛŒØ³ÛŒÙˆÙ†/Ú©Ø§Ø±Ù…Ø²Ø¯ Ú©Ù„ ($)</label>
            <input id="fees" type="number" step="0.01" value="0">
          </div>
          <div>
            <label>Ù„ØºØ²Ø´ + Ø§Ø³Ù¾Ø±Ø¯ (ÙˆØ§Ø­Ø¯ Ø­Ø±Ú©Øª)</label>
            <input id="slippage" type="number" step="0.01" value="0">
            <div class="hint">Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø«Ø§Ù„ 0.5 Ø¯Ù„Ø§Ø± Ø±ÙˆÛŒ Ø·Ù„Ø§ ÛŒØ§ 0.5 Ù¾ÛŒÙ¾ Ø±ÙˆÛŒ ÙØ§Ø±Ú©Ø³</div>
          </div>
        </div>

        <div class="bar">
          <button class="btn" id="autoUnit">ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø±Ø²Ø´ Ø­Ø±Ú©Øª</button>
          <button class="btn primary" id="calcBtn">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
          <button class="btn" id="addBtn">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„</button>
          <button class="btn outline" id="saveBtn">Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±</button>
          <button class="btn outline" id="loadBtn">Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ</button>
        </div>

        <div class="kpis">
          <div class="kpi"><h3>Ø­Ø¬Ù… (Ù„Ø§Øª)</h3><p id="kLot">-</p></div>
          <div class="kpi"><h3>Ø±ÛŒØ³Ú© Ø¯Ù„Ø§Ø±ÛŒ</h3><p id="kRisk">-</p></div>
          <div class="kpi"><h3>Ø³ÙˆØ¯ Ø¨Ø§Ù„Ù‚ÙˆÙ‡</h3><p id="kProfit">-</p></div>
          <div class="kpi"><h3>Ù†Ø³Ø¨Øª R:R</h3><p id="kRR">-</p></div>
        </div>

        <div class="chips">
          <span class="chip">Forex ØºÛŒØ±Ù JPY â†’ 1 pip/lot â‰ˆ $10</span>
          <span class="chip">USDJPY â†’ pip/lot â‰ˆ 1000 / Price</span>
          <span class="chip">XAUUSD â†’ $1/lot = $100</span>
          <span class="chip">WTI (ØªÙ‚Ø±ÛŒØ¨ÛŒ) â†’ $1/lot = $1000</span>
        </div>
      </div>

      <!-- Tips -->
      <div class="card col-3">
        <h3 style="margin:0 0 8px">Ù†Ú©Ø§Øª Ø³Ø±ÛŒØ¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©</h3>
        <ul style="margin:0 0 8px 0;padding:0 18px 0 0;line-height:1.8;color:var(--muted);font-size:13px">
          <li>Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Û°.Ûµ% ØªØ§ Û²% Ø±ÛŒØ³Ú© Ø¯Ø± Ù‡Ø± Ù…Ø¹Ø§Ù…Ù„Ù‡.</li>
          <li>R:R Ø²ÛŒØ± 1 Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¬Ø°Ø§Ø¨ Ù†ÛŒØ³ØªØ› Ø¨Ø§Ù„Ø§ÛŒ 2 Ù…Ø·Ù„ÙˆØ¨â€ŒØªØ± Ø§Ø³Øª.</li>
          <li>Ù„ØºØ²Ø´ Ùˆ Ú©Ø§Ø±Ù…Ø²Ø¯ Ø±Ø§ Ø¯Ø± Ø¨ÙˆØ¯Ø¬Ù‡ Ø±ÛŒØ³Ú© Ù„Ø­Ø§Ø¸ Ú©Ù†.</li>
          <li>Ù…Ø§Ø±Ø¬ÛŒÙ† ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³ØªØ› Ù…Ù‚Ø¯Ø§Ø± Ø¯Ù‚ÛŒÙ‚ Ø±Ø§ Ø¯Ø± Ù¾Ù„ØªÙØ±Ù… Ø¨Ø±ÙˆÚ©Ø± Ú†Ú© Ú©Ù†.</li>
        </ul>
        <div class="chip">ğŸ›ˆ Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
      </div>

      <!-- Table -->
      <div class="card col-12">
        <div class="bar">
          <button class="btn outline" id="exportCsv">Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV</button>
          <button class="btn outline" id="clearTable">Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„</button>
        </div>
        <table id="table">
          <thead>
            <tr>
              <th>#</th><th>Ù†Ù…Ø§Ø¯</th><th>ÙˆØ±ÙˆØ¯</th><th>SL</th><th>TP</th>
              <th>ÙØ§ØµÙ„Ù‡ ØªØ§ SL</th><th>$/ÙˆØ§Ø­Ø¯/Ù„Ø§Øª</th><th>Ù„Ø§Øª</th>
              <th>Ø±ÛŒØ³Ú© ($)</th><th>Ø³ÙˆØ¯ ($)</th><th>R:R</th><th>Ù…Ø§Ø±Ø¬ÛŒÙ† ØªÙ‚Ø±ÛŒØ¨ÛŒ ($)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ======= Logic =======
    const $ = id => document.getElementById(id);
    const rows = [];

    function autoUnit(){
      const typ = $("instrument").value;
      const entry = parseFloat($("entry").value || 0);
      if(typ === "gold"){ $("unitValue").value = 100; return; }
      if(typ === "forex"){ $("unitValue").value = 10; return; }
      if(typ === "forex-jpy"){
        $("unitValue").value = entry>0 ? (1000/entry).toFixed(2) : 7;
      }
    }

    function calc(){
      const entry = parseFloat($("entry").value);
      const sl = parseFloat($("sl").value);
      let tp = parseFloat($("tp").value);
      const rrTarget = parseFloat($("rrTarget").value || "2");
      const unit = parseFloat($("unitValue").value);
      const bal = parseFloat($("balance").value);
      const rPct = parseFloat($("riskPct").value);
      const fees = parseFloat($("fees").value || "0");
      const slip = parseFloat($("slippage").value || "0");

      if(!isFinite(entry)||!isFinite(sl)||!isFinite(unit)||!isFinite(bal)||!isFinite(rPct)||unit<=0){
        alert("ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯"); return null;
      }

      const dist = Math.abs(entry - sl) + (slip||0);      // ÙØ§ØµÙ„Ù‡ ØªØ§ Ø§Ø³ØªØ§Ù¾
      const riskUSD = bal * (rPct/100);                   // Ø¨ÙˆØ¯Ø¬Ù‡ Ø±ÛŒØ³Ú©
      const lot = riskUSD / (dist * unit);                // Ø­Ø¬Ù… Ù„Ø§Øª

      if(!isFinite(tp)){
        // Ø¬Ù‡Øª TP Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬Ù‡Øª Ø§Ø³ØªØ§Ù¾
        const dir = Math.sign(entry - sl); // Ø§Ú¯Ø± SL Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø¨Ø§Ø´Ø¯ØŒ dir Ù…Ø«Ø¨Øª (Ø®Ø±ÛŒØ¯)
        tp = entry + (dir * dist * (rrTarget||2));
      }

      const distTP = Math.abs(tp - entry);
      const grossProfit = lot * distTP * unit;
      const profit = grossProfit - (fees||0);
      const rr = profit / (riskUSD || 1);

      // Ù…Ø§Ø±Ø¬ÛŒÙ† ØªÙ‚Ø±ÛŒØ¨ÛŒ
      const lev = parseFloat($("leverage").value || "100");
      const typ = $("instrument").value;
      let margin = 0;
      if(typ === "gold"){
        // 1 lot â‰ˆ 100 oz â†’ notional = lot * 100 * entry
        margin = (lot * 100 * entry) / lev;
      }else if(typ.startsWith("forex")){
        // non-JPY approx notional = lot*100000*entry  |  JPY approx lot*100000
        const notional = typ==="forex-jpy" ? (lot*100000) : (lot*100000*entry);
        margin = notional/lev;
      }

      // Ù†Ù…Ø§ÛŒØ´ KPI
      $("kLot").innerText = lot>0 ? lot.toFixed(3) : "-";
      $("kRisk").innerText = isFinite(riskUSD) ? riskUSD.toFixed(2) : "-";
      $("kProfit").innerText = isFinite(profit) ? profit.toFixed(2) : "-";
      $("kRR").innerText = isFinite(rr) ? rr.toFixed(2) : "-";

      // Ø±Ù†Ú¯ R:R Ø¯Ø± KPI (Ø¨ØµÙˆØ±Øª Ø³Ø§Ø¯Ù‡)
      const rrEl = $("kRR");
      rrEl.classList.remove("tag-ok","tag-bad","tag-warn");
      if(rr >= 2) rrEl.classList.add("tag-ok");
      else if(rr < 1) rrEl.classList.add("tag-bad");
      else rrEl.classList.add("tag-warn");

      return {entry, sl, tp, dist, unit, lot, riskUSD, profit, rr, margin};
    }

    function addRow(){
      const sym = $("symbol").value.trim() || "-";
      const r = calc(); if(!r) return;
      rows.push({sym, ...r});
      render(); saveLocal();
    }

    function render(){
      const tb = document.querySelector("#table tbody");
      tb.innerHTML = "";
      rows.forEach((r,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.sym}</td>
          <td>${num(r.entry)}</td>
          <td>${num(r.sl)}</td>
          <td>${num(r.tp)}</td>
          <td>${num(r.dist,4)}</td>
          <td>${num(r.unit)}</td>
          <td>${num(r.lot,3)}</td>
          <td>${num(r.riskUSD)}</td>
          <td>${num(r.profit)}</td>
          <td class="${r.rr>=2?'tag-ok':(r.rr<1?'tag-bad':'tag-warn')}">${num(r.rr,2)}</td>
          <td>${num(r.margin)}</td>`;
        tb.appendChild(tr);
      });
    }

    function num(v,dec=2){ return isFinite(v) ? Number(v).toFixed(dec) : "-"; }

    function exportCsv(){
      const header = ["#","Symbol","Entry","SL","TP","DistToSL","$/Unit/Lot","Lot","Risk$","Profit$","R:R","Margin$"];
      const lines = [header.join(",")];
      rows.forEach((r,i)=>{
        lines.push([i+1,r.sym,r.entry,r.sl,r.tp,r.dist,r.unit,r.lot,r.riskUSD,r.profit,r.rr,r.margin].join(","));
      });
      const blob = new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="trades.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function saveLocal(){ localStorage.setItem("riskCalcRows", JSON.stringify(rows)); }
    function loadLocal(){ const s = localStorage.getItem("riskCalcRows"); if(s){ rows.length=0; JSON.parse(s).forEach(x=>rows.push(x)); render(); } }

    $("autoUnit").onclick = autoUnit;
    $("calcBtn").onclick  = calc;
    $("addBtn").onclick   = addRow;
    $("exportCsv").onclick= exportCsv;
    $("clearTable").onclick= ()=>{ rows.length=0; render(); saveLocal(); };
    $("saveBtn").onclick  = saveLocal;
    $("loadBtn").onclick  = loadLocal;

    // init
    autoUnit(); loadLocal();
  </script>
</body>
</html>
